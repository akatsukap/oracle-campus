import streamlit as st
import os
import sys

# utilsãƒ•ã‚©ãƒ«ãƒ€ã‚’èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ãƒ‘ã‚¹ã‚’é€šã™
sys.path.insert(0, os.path.dirname(__file__))
from utils import load_data, save_data

def main():
    st.set_page_config(
        page_title="Oracle Campus - Login",
        page_icon="ğŸ“",
        layout="centered"  # ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãªã®ã§ä¸­å¤®å¯„ã›ãŒè¦‹ã‚„ã™ã„
    )

    # ----------------------------------------
    # 1. ã‚¿ã‚¤ãƒˆãƒ«ã¨å°å…¥
    # ----------------------------------------
    st.title("ğŸ“ Oracle Campus")
    st.caption("ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ Ã— é›†åˆçŸ¥ã«ã‚ˆã‚‹æœªæ¥äºˆæ¸¬ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ")
    
    st.markdown("""
    ### Welcome!
    ã“ã“ã¯ã€å¤§å­¦å†…ã®ã‚ã‚‰ã‚†ã‚‹æœªæ¥ã‚’äºˆæ¸¬ã™ã‚‹å¸‚å ´ã§ã™ã€‚
    ã‚ãªãŸã®äºˆæ¸¬èƒ½åŠ›ï¼ˆã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼‰ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
    """)

    st.divider()

    # ----------------------------------------
    # 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠï¼ˆæ“¬ä¼¼ãƒ­ã‚°ã‚¤ãƒ³ï¼‰
    # ----------------------------------------
    st.subheader("ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³è¨­å®š")
    st.info("ãƒ‡ãƒ¢ç”¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦ï¼‰")

    # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    data = load_data()
    users = data.get("users", {})
    
    # ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚‹
    if not users:
        users = {
            "student1": {"points": 1000},
            "student2": {"points": 1000},
            "admin": {"points": 99999}
        }
        data["users"] = users
        save_data(data)

    # é¸æŠè‚¢ã‚’ä½œæˆ (adminã‚’å…ˆé ­ã«ã€ã‚ã¨ã¯è¾æ›¸é †)
    user_list = list(users.keys())
    # adminãŒã„ã‚Œã°ãƒªã‚¹ãƒˆã®å…ˆé ­ã«æŒã£ã¦ãã‚‹å°æŠ€
    if "admin" in user_list:
        user_list.remove("admin")
        user_list.insert(0, "admin")

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚å¿˜ã‚Œãªã„ã‚ˆã†ã«ï¼‰
    current_user = st.session_state.get("user_id", user_list[0])
    
    # é¸æŠãƒœãƒƒã‚¯ã‚¹ï¼ˆã‚‚ã—ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªã‚¹ãƒˆã«ãªã‘ã‚Œã°å…ˆé ­ã‚’é¸æŠï¼‰
    try:
        index = user_list.index(current_user)
    except ValueError:
        index = 0

    selected_user = st.selectbox("åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ:", user_list, index=index)

    # ----------------------------------------
    # 3. ãƒ­ã‚°ã‚¤ãƒ³ç¢ºå®šå‡¦ç†
    # ----------------------------------------
    if st.button("ğŸš€ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å§‹ã‚ã‚‹", type="primary"):
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã«ä¿å­˜ï¼ˆã“ã‚ŒãŒä»–ã®ãƒšãƒ¼ã‚¸ã§ "user_id" ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ï¼‰
        st.session_state["user_id"] = selected_user
        
        st.success(f"ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ: **{selected_user}**")
        st.caption("å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’ç§»å‹•ã—ã¦ãã ã•ã„ã€‚")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¡ˆå†…è¡¨ç¤º
        if selected_user == "admin":
            st.warning("ã‚ãªãŸã¯ã€Œç®¡ç†è€…æ¨©é™ã€ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã™ã€‚`9_Admin` ãƒšãƒ¼ã‚¸ã§å¸‚å ´ç®¡ç†ãŒå¯èƒ½ã§ã™ã€‚")
        else:
            st.info(f"ç¾åœ¨ã®æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: {users[selected_user].get('points', 0)} (Local Base)")

    # ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã«ã‚‚ä¾¿åˆ©ï¼‰
    st.markdown("---")
    if "user_id" in st.session_state:
        st.write(f"ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼: `{st.session_state['user_id']}`")
    else:
        st.write("ç¾åœ¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã§ã™ã€‚")

if __name__ == "__main__":
    main()
