import streamlit as st
from utils import load_data


# ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
st.title("Oracle Campus ğŸ“")
st.subheader("äºˆæ¸¬å¸‚å ´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰")

# ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—
user_id = st.session_state.get("user_id")

if not user_id:
    st.warning("ã¾ãšãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
data = load_data()
users = data.get("users", {})
markets = data.get("markets", [])

# ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç¢ºèª
user = users.get(user_id)

if not user:
    st.error(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ {user_id} ã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. è‡ªåˆ†ã®ãƒã‚¤ãƒ³ãƒˆæƒ…å ±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("### ğŸ‘¤ ã‚ãªãŸã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹")

st.write(f"- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼š`{user_id}`")
st.write(f"- æ‰€æŒãƒã‚¤ãƒ³ãƒˆï¼š**{user.get('points', 0)} OCP**")

st.divider()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. å‹Ÿé›†ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("### ğŸ“ˆ å‹Ÿé›†ä¸­ã®äºˆæ¸¬ã‚¤ãƒ™ãƒ³ãƒˆ")

open_markets = [m for m in markets if m.get("status") == "open"]

if not open_markets:
    st.info("ç¾åœ¨ã€æŠ•ç¥¨å—ä»˜ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
else:
    for m in open_markets:
        st.markdown(f"#### ğŸŸ¢ {m.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š')}")
        if desc := m.get("description"):
            st.write(desc)

        st.write(
            f"- Yes åˆè¨ˆï¼š**{m.get('yes_bets', 0)}** OCP  "
            f"- No åˆè¨ˆï¼š**{m.get('no_bets', 0)}** OCP"
        )

        # æŠ•ç¥¨ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ï¼ˆStreamlit ãƒãƒ«ãƒãƒšãƒ¼ã‚¸æƒ³å®šï¼‰
        st.page_link(
            "pages/2_Vote.py",
            label="ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«æŠ•ç¥¨ã™ã‚‹ ğŸ—³ï¸",
            icon="â¡ï¸",
        )

        st.divider()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. çµ‚äº†æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ¦‚è¦ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("### âœ… çµ‚äº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚µãƒãƒªï¼‰")

closed_markets = [m for m in markets if m.get("status") == "closed"]

if not closed_markets:
    st.write("ã¾ã çµ‚äº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
else:
    for m in closed_markets:
        st.markdown(f"- **{m.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š')}**ï¼šçµæœ â†’ `{m.get('result', 'æœªç¢ºå®š')}`")
